services:
  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: mmbp-backend
    restart: unless-stopped
    expose:
      - "8081"
    environment:
      - NODE_ENV=production
      - PORT=8081
      - MONGODB_URI=${MONGODB_URI}
      - CORS_ORIGIN=${CORS_ORIGIN:-https://mymonthlybudgetplan.com}
      - JWT_SECRET=${JWT_SECRET}
      - FIREBASE_PROJECT_ID=${FIREBASE_PROJECT_ID}
      - FIREBASE_CLIENT_EMAIL=${FIREBASE_CLIENT_EMAIL}
      - FIREBASE_PRIVATE_KEY=${FIREBASE_PRIVATE_KEY}
    networks:
      - mmbp-network
    healthcheck:
      test: ["CMD-SHELL", "wget --quiet --tries=1 --spider http://localhost:8081/test || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  # Frontend build service (builds static files)
  # container_name deliberately omitted to avoid name collisions on re-runs
  frontend-build:
    build:
      context: ./frontend
      dockerfile: Dockerfile
      args:
        - VITE_FIREBASE_API_KEY=${VITE_FIREBASE_API_KEY}
        - VITE_FIREBASE_AUTH_DOMAIN=${VITE_FIREBASE_AUTH_DOMAIN}
        - VITE_FIREBASE_PROJECT_ID=${VITE_FIREBASE_PROJECT_ID}
        - VITE_FIREBASE_STORAGE_BUCKET=${VITE_FIREBASE_STORAGE_BUCKET}
        - VITE_FIREBASE_MESSAGING_SENDER_ID=${VITE_FIREBASE_MESSAGING_SENDER_ID}
        - VITE_FIREBASE_APP_ID=${VITE_FIREBASE_APP_ID}
        - VITE_FIREBASE_MEASUREMENT_ID=${VITE_FIREBASE_MEASUREMENT_ID}
    volumes:
      # Mount volume at /dist-vol (not /app/dist) so the baked-in /app/dist is visible
      - frontend-dist:/dist-vol
    command: ["sh", "-c", "cp -a /app/dist/. /dist-vol/ && chmod -R 755 /dist-vol"]

  # Caddy reverse proxy and static file server
  caddy:
    image: caddy:2-alpine
    container_name: mmbp-caddy
    restart: unless-stopped
    depends_on:
      - backend
      - frontend-build
    ports:
      - "80:80"
      - "443:443"
      # - "443:443/udp" # For HTTP/3 TODO: Understand it
    environment:
      - DOMAIN=${DOMAIN:-mymonthlybudgetplan.com}
    volumes:
      # Mount frontend dist files for serving
      # Make /usr/share/caddy use files of frontend-dist
      - frontend-dist:/usr/share/caddy:ro
      # Mount Caddyfile configuration
      - ./Caddyfile:/etc/caddy/Caddyfile:ro
      # Persist Caddy data (certificates, etc.)
      - caddy_data:/data
      - caddy_config:/config
    networks:
      - mmbp-network

networks:
  mmbp-network:
    driver: bridge

volumes:
  frontend-dist:
  caddy_data:
  caddy_config: